{{ header }}
<script src="https://js.stripe.com/v3/"></script>

<div class="pricing-subscription">
    <div class="bg-gradient">
        <div class="container">
            <ul class="breadcrumb">
                {% for breadcrumb in breadcrumbs %}
                    <li><a href="{{ breadcrumb.href }}">{{ breadcrumb.text }}</a></li>
                {% endfor %}
            </ul>
            {% if success %}
                <div class="alert alert-success alert-dismissible"><i
                            class="fa fa-check-circle"></i> {{ success }}</div>
            {% endif %}

            {% if checkPlan %}
                <h4 class="f-35 text-center font-weight-bold">Update Membership Plan</h4>
                <div class="text-center mb-2"><small>Upgrade / Degrade your membership plan from here</small></div>
                <span class="btn-sm btn-success">{{ subscribed_plan.name }}</span>
            {% else %}
                <h4 class="f-35 text-center font-weight-bold mb-5">Subscribe New Membership Plan</h4>
            {% endif %}

            <form id="form-subscription" action="{{ action_subscribe }}" method="post">
                    {% for plan in plans %}
                <div class="row m-auto text-center justify-content-center">
                        <div class="col-md-5 princing-item mb-5">

                            <div class="pricing-divider d-flex align-items-center">

                                <div class="card-body bg-white mt-0 shadow">
                                    <input type="radio" name="radioPlan" value="{{ plan.stripe_plan_id }}"
                                           data-id="{{ plan.plan_id }}" class="icheck-input checkPlan"/>
                                </div>
                                <div class="card-text">
                                    <h3 class="text-light plan-name">{{ plan.name }}</h3>
                                    <h4 class="my-0 display-2 text-light font-weight-normal mb-3 plan-amount">
                                        Monthly rental is {{ plan.amount }} plus a {{ plan.rent_percentage }}% of each
                                        product sold
                                    </h4>
                                </div>

                                {# <svg class='pricing-divider-img' enable-background='new 0 0 300 100' height='100px' #}
                                {# id='Layer_1' preserveAspectRatio='none' version='1.1' viewBox='0 0 300 100' #}
                                {# width='300px' x='0px' xml:space='preserve' y='0px'> #}
                                {# <path class='deco-layer deco-layer--4' #}
                                {# d='M-34.667,62.998c0,0,56-45.667,120.316-27.839C167.484,57.842,197,41.332,232.286,30.428	c53.07-16.399,104.047,36.903,104.047,36.903l1.333,36.667l-372-2.954L-34.667,62.998z' #}
                                {# fill='#FFFFFF'></path> #}
                                {# </svg> #}
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <div class="text-provide-details row m-auto justify-content-center">
                    <div class="col-md-7">
                        <p>
                            Please provide your name and card details where the monthly rental would be deducted. You
                            can change/add new cards from your dashboard as need be.
                        </p>
                    </div>

                </div>

                <div class="row m-auto text-center justify-content-center">

                    <div class="col-md-7">
                        <div class="group">
                            <label>
                                <span>Name</span>
                                <input id="name" name="sellerName" class="field" placeholder="Jane Doe"/>
                            </label>
                            <label>
                                <span>Card</span>
                                <div id="card-element" class="field"></div>
                            </label>
                        </div>


                        <input type="hidden" name="stripe_token" id="stripe_token"/>
                        <input type="hidden" name="plan_id" id="plan_id">

                        <input type="submit" value="Pay"
                               class="btn btn-primary w-100 bg-success my-3 border-0 custom-btn">
                        <div class="outcome">
                            <div class="error"></div>
                            <div class="success">
                                {# Success! Your Stripe token is <span class="token"></span> #}
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{{ footer }}

<script>
    var stripe = Stripe('pk_test_51H8inyJvSOEFkXrXeZUINSYh5ItyqZSskzu1mfmVTGTHoEcp5KNiBtdGjiKfjiLh9wwdTjnifMuHfbWGLFuCyc2A0052ZePgjl');
    var elements = stripe.elements();

    var card = elements.create('card', {
        style: {
            base: {
                iconColor: '#666EE8',
                color: '#31325F',
                lineHeight: '40px',
                fontWeight: 300,
                fontFamily: 'Helvetica Neue',
                fontSize: '15px',

                '::placeholder': {
                    color: '#CFD7E0',
                },
            },
        }
    });
    card.mount('#card-element');

    function setOutcome(result) {
        var successElement = document.querySelector('.success');
        var errorElement = document.querySelector('.error');
        successElement.classList.remove('visible');
        errorElement.classList.remove('visible');

        if (result.token) {
// Use the token to create a charge or a customer
// https://stripe.com/docs/charges
            //successElement.querySelector('.token').textContent = result.token.id;
            $('#stripe_token').val(result.token.id);
            var plan_id = $("input[name*='radioPlan']:checked").attr('data-id');
            var radioValue = $("input[name='radioPlan']:checked").attr('value');

            $('#plan_id').val(plan_id);
            successElement.classList.add('visible');
            $('form#form-subscription').submit();

        } else if (result.error) {
            errorElement.textContent = result.error.message;
            errorElement.classList.add('visible');
        }
    }

    card.on('change', function (event) {
        setOutcome(event);
    });

    document.querySelector('form#form-subscription').addEventListener('submit', function (e) {

        e.preventDefault();
        var name = document.getElementById('name').value;
        if (!name) {
            var errorElement = document.querySelector('.error');
            errorElement.textContent = "You must enter a name.";
            errorElement.classList.add('visible');
            return;
        }
        var options = {
            name: name,
        };
        stripe.createToken(card, options).then(setOutcome);
    });
</script>